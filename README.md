# Google Calendar Tasks Sync for Obsidian

Obsidian のタスク（Markdown のチェックボックス行）を **Google カレンダーのイベント**として同期します。
ローカルのループバック HTTP サーバーを使った **OAuth 2.0（PKCE）** 認証、AIMD によるバッチ最適化で、速く安定した同期を行います。

---

## 概要

* Obsidian のタスク行を解析し、Google カレンダーの予定を作成・更新・削除
* 開始（start）と期限（due）をイベントの開始/終了にマップ
* RRULE と簡易自然言語の繰り返しルールをサポート
* 重複判定キーを柔軟に構成（説明/リマインダーの含有可）
* バッチ送信を自動チューニング（AIMD、並列実行、レート検知）
* トークンの暗号化保存（AES-GCM 併用可）
* ループバック URL（例：`http://127.0.0.1:3000/oauth2callback`）で OAuth コールバック

> 本 README では装飾目的の絵文字は使用していません。**解析対象として必要な記号のみ**、コードブロック内で示しています。

---

## 必要環境

* Obsidian 1.5+（デスクトップ）
* Google アカウント（Google Calendar API を有効化）
* Google Cloud Console 上の OAuth クライアント（Web アプリ推奨）

---

## Google Cloud Console の準備

1. プロジェクトを作成 → **API とサービス** → ライブラリで「Google Calendar API」を有効化
2. **OAuth 同意画面**を設定（テストユーザーに自分を追加）
3. **認証情報** → **OAuth クライアント ID 作成**（種類：Web アプリ）
4. 承認済みリダイレクト URI に、Obsidian の設定タブに表示される URI を **そのまま**登録

   * 既定例：`http://127.0.0.1:3000/oauth2callback`
   * プラグインがポートを自動変更した場合、**Console 側の URI も同じポートに更新**してください

---

## インストール

### ユーザー

1. リリースの zip を `{Vault}/.obsidian/plugins/google-calendar-tasks-sync/` に展開
2. Obsidian → 設定 → コミュニティプラグイン → 有効化

### 開発者

```bash
git clone <this-repo>
cd google-calendar-tasks-sync
npm i
npm run build   # or: npm run dev
# ビルド先を {Vault}/.obsidian/plugins/google-calendar-tasks-sync に配置
```

---

## 初期設定（Obsidian 側）

設定 → **Google Calendar Sync 設定**：

1. **クライアント ID / クライアントシークレット** を入力
2. **ローカルサーバーポート** を確認（既定: 3000）
3. 設定タブに表示される **リダイレクト URI** を Google Cloud Console に登録
4. **認証** ボタンを押してブラウザで承認

   * ポートが使用中なら自動で別ポートに切り替えます。その場合は **Console の URI も更新**してください

---

## 同期の基本ルール

* **同期対象**：開始（start）と期限（due）の **両方**があるタスク
* **終日/時間指定**：

  * `YYYY-MM-DD` → 終日
  * `YYYY-MM-DD HH:mm` または ISO8601（`Z` / `+09:00` など） → 時間指定
* 期限だけあって開始が無い場合は、開始を期限と同じに補完（内部ログに出力）
* 期限が開始より前になるときは、設定の「デフォルトイベント期間（分）」を適用

### フィールド対応表

| Obsidian 記法                    | 意味             | Google Calendar |
| ------------------------------ | -------------- | --------------- |
| `start:` または `🛫`              | 開始日時           | `event.start`   |
| `due:` または `📅`                | 終了日時           | `event.end`     |
| `scheduled:` または `⏳`           | 予定日（同期判定には不使用） | 説明欄へ（設定で有効時）    |
| `repeat:` / `recur:` または `🔁`  | 繰り返し           | RRULE           |
| `created:` / `➕`、`done:` / `✅` | 作成/完了日         | メタ情報として保持       |
| 優先度（`🔺/⏫/🔼/🔽/⏬`）            | プライオリティ        | 説明欄へ（設定で有効時）    |
| `#tag`                         | タグ             | 説明欄へ（設定で有効時）    |
| `^block-id`                    | ブロックリンク        | 説明欄へ（設定で有効時）    |

> 絵文字は **解析対象としてのみ**表に示しています。タスク記述は **テキスト形式（`start:` / `due:` など）だけでも**動作します。

---

## タスク記法の詳細

* 対象はチェックボックス行：`- [ ] ...` / `- [x] ...`
* **コードブロック（\`\`\` / \~\~\~）内は無視**
* メタデータ例：

  ````md
- [ ] テスト1 🛫 2025-08-31 📅 2025-08-31 
- [ ] テスト2🛫 2025-08-31 15:00 📅 2025-08-31 
- [ ] テスト3🛫 2025-08-31 17:00 📅 2025-08-31 23:00
- [ ] テスト4🛫 2025-08-31 📅 2025-09-02 🔁 every day 13:00~15:00
- [ ] テスト5🛫 2025-08-31 📅 2025-09-15🔁 every week on Sunday 08:00~10:00
- [ ] テスト6🛫 2025-08-31 
      これは作成されない
- [ ] テスト7📅 2025-08-31 
      これは作成される

```
- [ ] テスト8📅 2025-08-31 
      これは作成されない
      コードブロックは非表示
```

- [x] テスト9 📅 2025-08-31 ✅ 2025-08-31
      表示されない（終了タスクは非表示）

- [ ] テスト10 🛫 2025-08-31 📅 2025-09-01 
      テスト10の詳細... 

  ````
* 繰り返し（フォールバックの簡易自然言語）：

  * `every day`, `every 2 weeks`, `monthly on the 15th`, `weekly tue,thu`, `weekday`, `weekend` など
  * `15:00~24:00` の時間窓は解析して保持（将来拡張向け）

---

## 重複判定

以下を組み合わせて同一性を判定します：

* `summary / start / end / recurrence / status`
* 設定により **説明** と **リマインダー構成** をキーに含めることが可能

---

## 設定のヒント

* 対象カレンダー ID：`primary` または特定カレンダーの ID
* 自動同期：ON/オフと間隔（分）
* 取得窓：フル同期時の過去/未来日数で API 負荷を抑制
* 説明欄への出力：優先度・タグ・予定日・ブロックリンクを選択可能
* バッチ最適化（上級者向け）：

  * 1HTTPバッチ上限、目標サブバッチサイズ、同時送信数、バッチ間遅延
  * p95 レイテンシが SLA 超過/レート検出時に自動縮退（AIMD）
  * 429/5xx 検出でクールダウンを挿入

---

## 認証・保存

* スコープ：`https://www.googleapis.com/auth/calendar.events`
* トークンは自動更新。保存は難読化に加え **AES-GCM**（任意のパスフレーズ）で強化可能
* 「パスフレーズを保存」をオフにすると、再起動で消えるメモリ保持モード

### 暗号化アルゴリズムと注意点

* AES-256-GCM + PBKDF2-SHA256（反復 120k、塩 16 バイト、IV 12 バイト）でトークンを暗号化
* 既定の保存形式 `obf1` は SHA-256 ベースのストリーム XOR に HMAC-SHA256 で整合性を付与した**難読化**方式
  * 機密性が必要な場合はパスフレーズ付き AES-GCM を利用し、パスフレーズの管理にも注意してください
* 実装は Node.js 標準の `crypto` を使用。`libsodium` などの実績あるライブラリへの移行も検討しています

---

## よくある問題と対処

* **redirect\_uri\_mismatch**：設定タブのリダイレクト URI が **Console に登録済みか**確認（ポート一致も必須）
* **invalid\_grant**：コード期限切れ/再利用・時刻ズレ等。最初から認証をやり直し、端末の時計も確認
* **ポート使用中**：プラグインが自動で別ポートに切替。**Console 側の URI も更新**
* **429/5xx**：同時送信数を下げる、バッチ間遅延を増やす、しばらく待って再実行
* **終日がずれる**：DTSTART はローカル日付基準で補完。必要なら時刻付きで明示

---

## 制限

* 開始と期限の両方が無いタスクは同期されません
* 同期単位は「1 行 = 1 タスク」
* 時間窓（`hh:mm~hh:mm`）は現状保持のみ

---

## コマンド / UI

* **今すぐ同期**：手動で 1 サイクル実行
* **タスクマップキャッシュをクリア**：タスクとイベントの対応を破棄（重複が出る可能性あり）
* **リモートを強制リセット**：管理対象イベントを全削除→再登録（危険操作）

---

## 開発メモ

* 技術要素：TypeScript / Obsidian API / googleapis / google-auth-library / rrule / moment
* 主なクラス：

  * `AuthService`：OAuth（PKCE）、トークン更新、Calendar クライアント初期化
  * `HttpServerManager`：`127.0.0.1:{port}` で OAuth コールバック受信
  * `TaskParser`：Markdown 行→構造体、RRULE 生成（自然言語フォールバック）
  * `BatchProcessor`：AIMD + 並列最適化、結果集計

---

## ライセンス

MIT

---

## 免責

本プラグインは Google カレンダーへ変更（削除を含む）を行います。
専用のカレンダーIDを使用することを推奨します。

---

## 連絡

バグ報告・改善提案は Issue へ。README の改善 PR も歓迎します。
